
import random
import numpy as np
from Crypto.Random import get_random_bytes
from utils import connect_web3 as connect
from web3 import Web3
from ethereum.utils import (
    int_to_bytes, sha3, bytes_to_int
)


# Modified Elgamal Encryption
def enc(m, r):
    c_1 = pow(g, r, p)
    c_2 = pow(h, r, p) * pow(g, m, p) % p
    return c_1, c_2

# Counting bit length
def count_bitlen(x):
    x_str = str(hex(x)).replace('0x', '')
    charlen = len(x_str)
    bitlen = charlen * 4
    if x_str[0] in ['1']:
        bitlen -= 3
    elif x_str[0] in ['2', '3']:
        bitlen -= 2
    elif x_str[0] in ['4', '5', '6', '7']:
        bitlen -= 1
    return bitlen


if __name__ == '__main__':


    # 2048-bit p,g,h

    p = 26584000737522469559255213278148540663947724825324296157281193261181560548636153467049388117146637651050841116751829414426641729125865212852845272219535094895612767586157054679717516525078771286758024931146883711257859724041313912413596611159824145205086037835560328376774374104238393705363248976976377110731807492414212611208135283317517981781090664549781709233590364297738977588232087692712917778615106562503850327667273702335065226779043136671032271076865811019258766329390243420432732327797472036475476983110047934083167758034940936965920779849084494935094949379247995973815460068664200438737256045065229041041507
    g = 7712753408539015955587720622866045086100737658337481818803197599971960501551987960329763761966211483394244124943769578134099531030721251638507169219664821394172654696079268857083072356298616293179600852690187523019225771640714262512850756102223895196207247716673151328947794893953663960508036604786330066702321170187240277571209647492040711829857030771488303715009803563714075588433395953781898664383110749056516840016010503246460028780087232571788079441040275400988084148082885247998601185855568509980811261405430579194522685045026121103372967942129139884107517415500506739791799824339395723091081118884213831565581


    h = 13251870080613962244737721687706273106480093106527837968840964008668962938461407859114170505716484147699869512634532780104972884748063570208445946922582950869786795666428742944621302016684014012201941593398348880749906774165962490477031052590125939323169391806789484548354460624368923998200144728829821771488134673775120745435691317647956748101647202402774327264888310300148632998177366500285349217369531400393929954673163875407447331556783381120362991170856522063887524678099307113608982679282267885105711370436476436963636178867943695628850419808323820879015776702111110898130915745928944648686142079368551229872633

    #128 bit k
    k = 224641234720801105233716524752813367606

    abi = '[{"constant":true,"inputs":[],"name":"gs","outputs":[{"name":"ctr","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"gold_count","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"gold_num","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"c1_val","type":"bytes"},{"name":"c1_bitlen","type":"uint256"},{"name":"z_val","type":"bytes"},{"name":"z_bitlen","type":"uint256"},{"name":"a_val","type":"bytes"},{"name":"hash_length","type":"uint256"},{"name":"solexp","type":"uint256"}],"name":"different_plaintext_proof_lhs","outputs":[{"name":"","type":"bytes"},{"name":"","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"_data","type":"bytes32"}],"name":"toBytes","outputs":[{"name":"","type":"bytes"}],"payable":false,"stateMutability":"pure","type":"function"},{"constant":true,"inputs":[],"name":"num_workers","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"addr","type":"address"},{"name":"question_index","type":"uint256"}],"name":"read_cipher_digest","outputs":[{"name":"","type":"bytes32"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"c1_val","type":"bytes"},{"name":"c1_bitlen","type":"uint256"},{"name":"c2_val","type":"bytes"},{"name":"c2_bitlen","type":"uint256"},{"name":"q_index","type":"uint256"},{"name":"worker_index","type":"address"},{"name":"a_val","type":"bytes"},{"name":"a_bitlen","type":"uint256"},{"name":"z_val","type":"bytes"},{"name":"z_bitlen","type":"uint256"},{"name":"hash_length","type":"uint256"}],"name":"different_plaintext_proof","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"num_questions","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"x","type":"uint256"}],"name":"toBytes","outputs":[{"name":"b","type":"bytes"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"answers_map","outputs":[{"name":"counter","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"indices","type":"uint256[]"},{"name":"sols","type":"uint256[]"},{"name":"r_val","type":"uint256"}],"name":"opening_phase","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"question_num","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"current_worker_num","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"i","type":"uint256"},{"name":"c_1","type":"bytes"},{"name":"c_2","type":"bytes"}],"name":"submit_answers","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"c2_val","type":"bytes"},{"name":"c2_bitlen","type":"uint256"},{"name":"a_val","type":"bytes"},{"name":"a_bitlen","type":"uint256"},{"name":"hash_length","type":"uint256"}],"name":"different_plaintext_proof_rhs","outputs":[{"name":"","type":"bytes"},{"name":"","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"workers_accts","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"i_val","type":"bytes32"},{"name":"s_val","type":"bytes32"}],"name":"fill_golden","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"name":"a","type":"bytes32"}],"name":"debug","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"b","type":"bytes32"}],"name":"debug1","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"a","type":"string"}],"name":"FillGold","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"b","type":"string"}],"name":"OpenGold","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"a","type":"string"}],"name":"PlainTextProof","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"c1","type":"bytes"},{"indexed":false,"name":"c2","type":"bytes"}],"name":"Ciphertexts","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"b","type":"string"}],"name":"Answers_Test","type":"event"}]'

    bin = '0x60806040526101206040519081016040528061010081526020016200373b6101009139601390805190602001906200003992919062000640565b5061012060405190810160405280610100815260200162003a3b6101009139601490805190602001906200006f92919062000640565b506101206040519081016040528061010081526020016200393b610100913960159080519060200190620000a592919062000640565b506101206040519081016040528061010081526020016200383b610100913960169080519060200190620000db92919062000640565b506101206040519081016040528061010081526020016200363b6101009139601790805190602001906200011192919062000640565b506107fe6018556107ff601955610800601a556107ff601b556001601c55604080519081016040528060138054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015620001d45780601f10620001a857610100808354040283529160200191620001d4565b820191906000526020600020905b815481529060010190602001808311620001b657829003601f168201915b50505050508152602001601854815250601d600082015181600001908051906020019062000204929190620006c7565b50602082015181600101555050604080519081016040528060148054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015620002b65780601f106200028a57610100808354040283529160200191620002b6565b820191906000526020600020905b8154815290600101906020018083116200029857829003601f168201915b50505050508152602001601954815250601f6000820151816000019080519060200190620002e6929190620006c7565b50602082015181600101555050604080519081016040528060168054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015620003985780601f106200036c5761010080835404028352916020019162000398565b820191906000526020600020905b8154815290600101906020018083116200037a57829003601f168201915b50505050508152602001601b5481525060216000820151816000019080519060200190620003c8929190620006c7565b50602082015181600101555050604080519081016040528060158054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156200047a5780601f106200044e576101008083540402835291602001916200047a565b820191906000526020600020905b8154815290600101906020018083116200045c57829003601f168201915b50505050508152602001601a5481525060236000820151816000019080519060200190620004aa929190620006c7565b50602082015181600101555050604080519081016040528060178054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156200055c5780601f1062000530576101008083540402835291602001916200055c565b820191906000526020600020905b8154815290600101906020018083116200053e57829003601f168201915b50505050508152602001601c54815250602560008201518160000190805190602001906200058c929190620006c7565b50602082015181600101555050348015620005a657600080fd5b5060016000806101000a81548160ff02191690836002811115620005c657fe5b021790555033600060016101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060018081905550600160028190555060046003819055506001600481905550606a6005819055506006808190555062000776565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106200068357805160ff1916838001178555620006b4565b82800160010185558215620006b4579182015b82811115620006b357825182559160200191906001019062000696565b5b509050620006c391906200074e565b5090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106200070a57805160ff19168380011785556200073b565b828001600101855582156200073b579182015b828111156200073a5782518255916020019190600101906200071d565b5b5090506200074a91906200074e565b5090565b6200077391905b808211156200076f57600081600090555060010162000755565b5090565b90565b612eb580620007866000396000f3006080604052600436106100fb576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff168062e71aaf14610100578063191335081461012b5780631bc5f5bf146101565780632d2f31af14610181578063326cf61c146101bf5780633c2906aa146101fc578063400322ca1461022757806344bc5f7e146102645780635b57172b146102a1578063775a8f5e146102cc578063908a938c146103095780639eae737b14610346578063a74dc58614610383578063b8a7068e146103ae578063bd42cb0d146103d9578063c08d763114610402578063c4907fa914610440578063e57f796d1461047d575b600080fd5b34801561010c57600080fd5b506101156104a6565b6040516101229190612d0d565b60405180910390f35b34801561013757600080fd5b506101406104b2565b60405161014d9190612d0d565b60405180910390f35b34801561016257600080fd5b5061016b6104b8565b6040516101789190612d0d565b60405180910390f35b34801561018d57600080fd5b506101a860048036036101a391908101906125c0565b6104be565b6040516101b6929190612c1d565b60405180910390f35b3480156101cb57600080fd5b506101e660048036036101e1919081019061255b565b610a5b565b6040516101f39190612bc4565b60405180910390f35b34801561020857600080fd5b50610211610a8c565b60405161021e9190612d0d565b60405180910390f35b34801561023357600080fd5b5061024e600480360361024991908101906124a0565b610a92565b60405161025b9190612ba9565b60405180910390f35b34801561027057600080fd5b5061028b6004803603610286919081019061274d565b610aed565b6040516102989190612b8e565b60405180910390f35b3480156102ad57600080fd5b506102b6610d87565b6040516102c39190612d0d565b60405180910390f35b3480156102d857600080fd5b506102f360048036036102ee919081019061289d565b610d8d565b6040516103009190612bc4565b60405180910390f35b34801561031557600080fd5b50610330600480360361032b9190810190612477565b610dd1565b60405161033d9190612d0d565b60405180910390f35b34801561035257600080fd5b5061036d600480360361036891908101906124dc565b610def565b60405161037a9190612b8e565b60405180910390f35b34801561038f57600080fd5b5061039861101b565b6040516103a59190612d0d565b60405180910390f35b3480156103ba57600080fd5b506103c3611021565b6040516103d09190612d0d565b60405180910390f35b3480156103e557600080fd5b5061040060048036036103fb91908101906128c6565b611027565b005b34801561040e57600080fd5b50610429600480360361042491908101906126a6565b61137c565b604051610437929190612c1d565b60405180910390f35b34801561044c57600080fd5b506104676004803603610462919081019061289d565b6116b5565b6040516104749190612b73565b60405180910390f35b34801561048957600080fd5b506104a4600480360361049f9190810190612584565b6116f4565b005b602780600c0154905081565b60065481565b60045481565b606060006104ca6122e4565b6104d26122e4565b6104da6122e4565b6104e26122e4565b61060589601360146040518084805190602001908083835b60208310151561051f57805182526020820191506020810190506020830392506104fa565b6001836020036101000a038019825116818451168082178552505050505050905001838054600181600116156101000203166002900480156105985780601f10610576576101008083540402835291820191610598565b820191906000526020600020905b815481529060010190602001808311610584575b5050828054600181600116156101000203166002900480156105f15780601f106105cf5761010080835404028352918201916105f1565b820191906000526020600020905b8154815290600101906020018083116105dd575b505093505050506040518091039020610a5b565b8460000181905250878460200181815250508c83600001819052508b8360200181815250508a826000018190525089826020018181525050600187141561096a576109636107ce856023604080519081016040529081600082018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156106f35780601f106106c8576101008083540402835291602001916106f3565b820191906000526020600020905b8154815290600101906020018083116106d657829003601f168201915b50505050508152602001600182015481525050601d604080519081016040529081600082018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156107ac5780601f10610781576101008083540402835291602001916107ac565b820191906000526020600020905b81548152906001019060200180831161078f57829003601f168201915b505050505081526020016001820154815250506117ba9092919063ffffffff16565b6023604080519081016040529081600082018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156108745780601f1061084957610100808354040283529160200191610874565b820191906000526020600020905b81548152906001019060200180831161085757829003601f168201915b50505050508152602001600182015481525050610954856023604080519081016040529081600082018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156109315780601f1061090657610100808354040283529160200191610931565b820191906000526020600020905b81548152906001019060200180831161091457829003601f168201915b50505050508152602001600182015481525050886117ba9092919063ffffffff16565b6118269092919063ffffffff16565b9050610a3a565b610a37826023604080519081016040529081600082018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610a145780601f106109e957610100808354040283529160200191610a14565b820191906000526020600020905b8154815290600101906020018083116109f757829003601f168201915b50505050508152602001600182015481525050856117ba9092919063ffffffff16565b90505b80600001518160200151819150955095505050505097509795505050505050565b6060816040516020018082600019166000191681526020019150506040516020818303038152906040529050919050565b60035481565b6000603460008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000182606a81101515610ae357fe5b0154905092915050565b6000610af76122e4565b610aff6122e4565b60008090505b600654811015610d7057600781600681101515610b1e57fe5b01548b1415610d63578e8d6040518083805190602001908083835b602083101515610b5e5780518252602082019150602081019050602083039250610b39565b6001836020036101000a03801982511681845116808217855250505050505090500182805190602001908083835b602083101515610bb15780518252602082019150602081019050602083039250610b8c565b6001836020036101000a03801982511681845116808217855250505050505090500192505050604051809103902060001916603460008c73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000018c606a81101515610c3257fe5b0154600019161415610d2557610c608f8f89898d8a600d88600681101515610c5657fe5b01546001036104be565b8191508460000185602001828152508290525050610c818d8d8b8b8961137c565b81915083600001846020018281525082905250506000610ca38484600161184a565b1415610ce7577fad9b8278dfd506d1c9decb1d44a43bcd3f244dab664f2bde7b11b924274d896c604051610cd690612ccd565b60405180910390a160019350610d75565b7fad9b8278dfd506d1c9decb1d44a43bcd3f244dab664f2bde7b11b924274d896c604051610d1490612c8d565b60405180910390a160009350610d75565b7fad9b8278dfd506d1c9decb1d44a43bcd3f244dab664f2bde7b11b924274d896c604051610d5290612cad565b60405180910390a160009350610d75565b8080600101915050610b05565b600093505b5050509b9a5050505050505050505050565b60055481565b606060206040519080825280601f01601f191660200182016040528015610dc35781602001602082028038833980820191505090505b509050816020820152919050565b603460205280600052604060002060009150905080606a0154905081565b600080600080600092505b60065483101561100c578683815181101515610e1257fe5b9060200190602002015160405180828152602001915050604051809103902085604051808281526020019150506040518091039020604051808360001916600019168152602001826000191660001916815260200192505050604051809103902091508583815181101515610e8357fe5b906020019060200201516040518082815260200191505060405180910390208560405180828152602001915050604051809103902060405180836000191660001916815260200182600019166000191681526020019250505060405180910390209050602760000183600681101515610ef857fe5b0154600019168260001916148015610f2a5750602760060183600681101515610f1d57fe5b0154600019168160001916145b15610fc1578683815181101515610f3d57fe5b90602001906020020151600784600681101515610f5657fe5b01819055508583815181101515610f6957fe5b90602001906020020151600d84600681101515610f8257fe5b01819055507ff9d5bc1f7d8ca67bb4dc255cfec9eda367d129d600e4c4c725d400580ae2bd82604051610fb490612ced565b60405180910390a1610fff565b7ff9d5bc1f7d8ca67bb4dc255cfec9eda367d129d600e4c4c725d400580ae2bd82604051610fee90612c6d565b60405180910390a160009350611011565b8280600101935050610dfa565b600193505b5050509392505050565b60025481565b60015481565b600080600033925084846040518083805190602001908083835b6020831015156110665780518252602082019150602081019050602083039250611041565b6001836020036101000a03801982511681845116808217855250505050505090500182805190602001908083835b6020831015156110b95780518252602082019150602081019050602083039250611094565b6001836020036101000a03801982511681845116808217855250505050505090500192505050604051809103902091507fd091997c5ee52de3a36f10ba7227df61fba641908380d2d6087eff5b408b2494858560405161111a929190612be6565b60405180910390a160008611156112615781603460008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000187606a8110151561117b57fe5b0181600019169055506001603460008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020606a01600082825401925050819055507f9bb4050ede07f453a7dacdff9c8bc4defc8410eda75069d79ccbbec83e2f21ad603460008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000187606a8110151561124557fe5b01546040516112549190612ba9565b60405180910390a1611374565b81816000016000606a8110151561127457fe5b018160001916905550600181606a018190555080603460008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082018160000190606a6112dd9291906122fe565b50606a82015481606a01559050507f9bb4050ede07f453a7dacdff9c8bc4defc8410eda75069d79ccbbec83e2f21ad603460008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000016000606a8110151561135c57fe5b015460405161136b9190612ba9565b60405180910390a15b505050505050565b606060006113886122e4565b6113906122e4565b6113986122e4565b6113a06122e4565b6114c389601360146040518084805190602001908083835b6020831015156113dd57805182526020820191506020810190506020830392506113b8565b6001836020036101000a038019825116818451168082178552505050505050905001838054600181600116156101000203166002900480156114565780601f10611434576101008083540402835291820191611456565b820191906000526020600020905b815481529060010190602001808311611442575b5050828054600181600116156101000203166002900480156114af5780601f1061148d5761010080835404028352918201916114af565b820191906000526020600020905b81548152906001019060200180831161149b575b505093505050506040518091039020610a5b565b846000018190525086846020018181525050888360000181905250878360200181815250508a8260000181905250898260200181815250506116946115cb856023604080519081016040529081600082018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156115a85780601f1061157d576101008083540402835291602001916115a8565b820191906000526020600020905b81548152906001019060200180831161158b57829003601f168201915b50505050508152602001600182015481525050856117ba9092919063ffffffff16565b6023604080519081016040529081600082018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156116715780601f1061164657610100808354040283529160200191611671565b820191906000526020600020905b81548152906001019060200180831161165457829003601f168201915b50505050508152602001600182015481525050856118269092919063ffffffff16565b90508060000151816020015181915095509550505050509550959350505050565b6101dd818154811015156116c557fe5b906000526020600020016000915054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b8160276000016027600c015460068110151561170c57fe5b0181600019169055508060276006016027600c015460068110151561172d57fe5b01816000191690555060016027600c01600082825401925050819055507fbe2e6cf1a5f5c472dddfcec10c595b7addbebc6bf89002859defae82d7fedf1760405161177790612c4d565b60405180910390a17f9bb4050ede07f453a7dacdff9c8bc4defc8410eda75069d79ccbbec83e2f21ad826040516117ae9190612ba9565b60405180910390a15050565b6117c26122e4565b606060006117dd866000015186600001518660000151611941565b9150602082015190506101006001602084518115156117f857fe5b04030261180482611a13565b0190508183600001819052508083602001818152505082925050509392505050565b61182e6122e4565b61184161183b8585611c64565b83611cc6565b90509392505050565b6000806000806000806000806001965089602001518b60200151111561187557866001029750611933565b8a602001518a6020015111156118af57867fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff029750611933565b8a6000015151915060208b5101955060208a51019450600090505b8181101561192e57808601519350808501519250828411156118f157866001029750611933565b8383111561192357867fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff029750611933565b6020810190506118ca565b600097505b505050505050509392505050565b606083518351835160405183815282602082015281604082015283606082018560208b0160046101c2fa84606001848184018660208c0160046101c2fa91508481019050838184018560208b0160046101c2fa915081600081146119a4576119a6565bfe5b5083810190508383606001828560056105465a03fa915081600081146119cb576119cd565bfe5b5083836060015b6001600082511414156119f2576020810190506020820391506119d4565b60208103985081895285856060010160405250505050505050509392505050565b60008082905060018303925060028304831792506004830483179250601083048317925061010083048317925062010000830483179250640100000000830483179250680100000000000000008304831792507001000000000000000000000000000000008304831792506001830192506040517ff8f9cbfae6cc78fbefe7cdc3a1793dfcf4f0e8bbd8cec470b6a28a7a5a3e1efd81527ff5ecf1b3e9debc68e1d9cfabc5997135bfb7a7a3938b7b606b5b4b3f2f1f0ffe60208201527ff6e4ed9ff2d6b458eadcdf97bd91692de2d4da8fd2d0ac50c6ae9a827252361660408201527fc8c0b887b0a8a4489c948c7f847c6125746c645c544c444038302820181008ff60608201527ff7cae577eec2a03cf3bad76fb589591debb2dd67e0aa9834bea6925f6a4a2e0e60808201527fe39ed557db96902cd38ed14fad815115c786af479b7e8324736353433727170760a08201527fc976c13bb96e881cb166a933a55e490d9d56952b8d4e801485467d236242260660c08201527f753a6d1b65325d0c552a4d1345224105391a310b29122104190a11030902010060e082015261010081016040527e818283848586878898a8b8c8d8e8f929395969799a9b9d9e9faaeb6bedeeff7f01000000000000000000000000000000000000000000000000000000000000008082870204818160ff038501510495507f800000000000000000000000000000000000000000000000000000000000000085116101000286019550505050506000600182038216148015611c52575060008314155b15611c5e578160010191505b50919050565b611c6c6122e4565b611c746122e4565b611c8084846000611d18565b91506000611c908585600161184a565b141515611cb257611ca384846001611d18565b9050611caf8282611e14565b91505b611cbd826002611efb565b91505092915050565b611cce6122e4565b611cd66122e4565b60408051908101604052806040805190810160405280602081526020016001815250815260200160018152509050611d0f8482856117ba565b91505092915050565b611d206122e4565b611d286122e4565b60008060606000611d376122e4565b604080519081016040528060408051908101604052806020815260200160028152508152602001600281525095506000945060008814611d8057611d7b8a8a611e14565b611d8b565b611d8a8a8a611fdb565b5b96508660200151915060028202945061010085811515611da757fe5b0660019060020a02935060408051908101604052806020815260200160008152509250602060016101008704010283528360208401526020835101830160405282816000018190525084816020018181525050611e058787836117ba565b96505050505050509392505050565b611e1c6122e4565b611e246122e4565b606060008060408051908101604052806040805190810160405280602081526020016000815250815260200160008152509350611e638787600061184a565b91506001821415611e8d57611e8087600001518760000151612060565b8092508194505050611edd565b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff821415611ed457611ec786600001518860000151612060565b8092508194505050611edc565b839450611ef1565b5b828560000181905250808560200181815250505b5050505092915050565b611f036122e4565b60606000806000806000806000896101000395508a6000015151915060206000039250818b510193506020820390505b82811015611f8657835196506000811460018114611f575760208503519550611f5c565b600095505b5089879060020a9004965085859060020a0294508487178452602084039350602081039050611f33565b6020840193505b600084511415611fa857602084019350602082039150611f8d565b602084039750818852878b60000181905250898b60200151038b60200181815250508a9850505050505050505092915050565b611fe36122e4565b6060600080611ff48686600061184a565b905060008112151561202457612017866000015186600001518860200151612171565b8093508194505050612044565b61203b856000015187600001518760200151612171565b80935081945050505b8284600001819052508184602001818152505050505092915050565b6060600060606000806000915059600160000388518851808203828c01828c0184870160208101865b6000808214141561211a578451868211600181146120cb578d8203855260018e146000831416600181146120c05760009e506120c5565b60019e505b50612101565b85518e81840303865260018f148c8214168f8201841017600181146120f35760009f506120f8565b60019f505b50602087039650505b5060208403935060208603955050602081039050612089565b506020820191505b60008251141561214357602089019850602087039650602082019150612122565b889b50868c528060405250505050505050505061215f836122c0565b90508281945094505050509250929050565b6060600060606000596001600003600089518a0189518a018b5160208601018c515b600080821414156122405783518d518f51038211600181146121d85786820184526001871482891416600181146121cd57600097506121d2565b600197505b50612227565b8451878184010185528781038903831160018114612219576000821160008a11178a8514166001811461220e5760009950612213565b600199505b5061221e565b600198505b50602086039550505b5060208303925060208503945050602081039050612193565b506000841460018114612256576001825261225d565b6020870196505b50859750836020028d51018852602088510188016040525050505050506020820151905060016101008681151561229057fe5b06829060020a900414806122a45750600181145b156122b0578460010194505b8185935093505050935093915050565b6000806020830151905060086020845103026122db82611a13565b01915050919050565b604080519081016040528060608152602001600081525090565b82606a810192821561232a579182015b8281111561232957825482559160010191906001019061230e565b5b509050612337919061233b565b5090565b61235d91905b80821115612359576000816000905550600101612341565b5090565b90565b600061236c8235612df4565b905092915050565b600082601f830112151561238757600080fd5b813561239a61239582612d55565b612d28565b915081818352602084019350602081019050838560208402820111156123bf57600080fd5b60005b838110156123ef57816123d58882612463565b8452602084019350602083019250506001810190506123c2565b5050505092915050565b60006124058235612e14565b905092915050565b600082601f830112151561242057600080fd5b813561243361242e82612d7d565b612d28565b9150808252602083016020830185838301111561244f57600080fd5b61245a838284612e28565b50505092915050565b600061246f8235612e1e565b905092915050565b60006020828403121561248957600080fd5b600061249784828501612360565b91505092915050565b600080604083850312156124b357600080fd5b60006124c185828601612360565b92505060206124d285828601612463565b9150509250929050565b6000806000606084860312156124f157600080fd5b600084013567ffffffffffffffff81111561250b57600080fd5b61251786828701612374565b935050602084013567ffffffffffffffff81111561253457600080fd5b61254086828701612374565b925050604061255186828701612463565b9150509250925092565b60006020828403121561256d57600080fd5b600061257b848285016123f9565b91505092915050565b6000806040838503121561259757600080fd5b60006125a5858286016123f9565b92505060206125b6858286016123f9565b9150509250929050565b600080600080600080600060e0888a0312156125db57600080fd5b600088013567ffffffffffffffff8111156125f557600080fd5b6126018a828b0161240d565b97505060206126128a828b01612463565b965050604088013567ffffffffffffffff81111561262f57600080fd5b61263b8a828b0161240d565b955050606061264c8a828b01612463565b945050608088013567ffffffffffffffff81111561266957600080fd5b6126758a828b0161240d565b93505060a06126868a828b01612463565b92505060c06126978a828b01612463565b91505092959891949750929550565b600080600080600060a086880312156126be57600080fd5b600086013567ffffffffffffffff8111156126d857600080fd5b6126e48882890161240d565b95505060206126f588828901612463565b945050604086013567ffffffffffffffff81111561271257600080fd5b61271e8882890161240d565b935050606061272f88828901612463565b925050608061274088828901612463565b9150509295509295909350565b60008060008060008060008060008060006101608c8e03121561276f57600080fd5b60008c013567ffffffffffffffff81111561278957600080fd5b6127958e828f0161240d565b9b505060206127a68e828f01612463565b9a505060408c013567ffffffffffffffff8111156127c357600080fd5b6127cf8e828f0161240d565b99505060606127e08e828f01612463565b98505060806127f18e828f01612463565b97505060a06128028e828f01612360565b96505060c08c013567ffffffffffffffff81111561281f57600080fd5b61282b8e828f0161240d565b95505060e061283c8e828f01612463565b9450506101008c013567ffffffffffffffff81111561285a57600080fd5b6128668e828f0161240d565b9350506101206128788e828f01612463565b92505061014061288a8e828f01612463565b9150509295989b509295989b9093969950565b6000602082840312156128af57600080fd5b60006128bd84828501612463565b91505092915050565b6000806000606084860312156128db57600080fd5b60006128e986828701612463565b935050602084013567ffffffffffffffff81111561290657600080fd5b6129128682870161240d565b925050604084013567ffffffffffffffff81111561292f57600080fd5b61293b8682870161240d565b9150509250925092565b61294e81612db4565b82525050565b61295d81612dd4565b82525050565b61296c81612de0565b82525050565b600061297d82612da9565b808452612991816020860160208601612e37565b61299a81612e6a565b602085010191505092915050565b6000601282527f476f6c642061727261792066696c6c65642100000000000000000000000000006020830152604082019050919050565b6000602282527f436f6d6d69746d656e7420746f20696e64657820616e6420736f6c2066616c7360208301527f65210000000000000000000000000000000000000000000000000000000000006040830152606082019050919050565b6000601a82527f4d616c6963696f757320506c61696e746578742050726f6f66210000000000006020830152604082019050919050565b6000602182527f486173686573206f6620436970686572746578747320646f6e2774206d61746360208301527f68000000000000000000000000000000000000000000000000000000000000006040830152606082019050919050565b6000601d82527f446966666572656e7420506c61696e74657874205665726966696564210000006020830152604082019050919050565b6000602482527f436f6d6d69746d656e7420746f20696e64657820616e6420736f6c20636f727260208301527f65637421000000000000000000000000000000000000000000000000000000006040830152606082019050919050565b612b6d81612dea565b82525050565b6000602082019050612b886000830184612945565b92915050565b6000602082019050612ba36000830184612954565b92915050565b6000602082019050612bbe6000830184612963565b92915050565b60006020820190508181036000830152612bde8184612972565b905092915050565b60006040820190508181036000830152612c008185612972565b90508181036020830152612c148184612972565b90509392505050565b60006040820190508181036000830152612c378185612972565b9050612c466020830184612b64565b9392505050565b60006020820190508181036000830152612c66816129a8565b9050919050565b60006020820190508181036000830152612c86816129df565b9050919050565b60006020820190508181036000830152612ca681612a3c565b9050919050565b60006020820190508181036000830152612cc681612a73565b9050919050565b60006020820190508181036000830152612ce681612ad0565b9050919050565b60006020820190508181036000830152612d0681612b07565b9050919050565b6000602082019050612d226000830184612b64565b92915050565b6000604051905081810181811067ffffffffffffffff82111715612d4b57600080fd5b8060405250919050565b600067ffffffffffffffff821115612d6c57600080fd5b602082029050602081019050919050565b600067ffffffffffffffff821115612d9457600080fd5b601f19601f8301169050602081019050919050565b600081519050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60008115159050919050565b6000819050919050565b6000819050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b6000819050919050565b82818337600083830152505050565b60005b83811015612e55578082015181840152602081019050612e3a565b83811115612e64576000848401525b50505050565b6000601f19601f83011690509190505600a265627a7a72305820fd5f33cedf122c4f4365972805b6c73214449209436e3d031502e5a00b55a19e6c6578706572696d656e74616cf50037000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000013d18c64b862beb04ecd05ba788a5aa57877bedaf24380d7d73335927c07461b7d435ed96b597f79b479b0014e8552da81b52f9dbb23b1599f84aa6cd49f6a93cae96708bde27a57f5193429711ac74f2befb85adae6b5365855ea417613813dccabbe535d04f043f3bb6a9b3b3574e58f82d30e9019ea6bc2e09f3d27123e51b90c13f55f51067563ba0589947e94893eab7676c70bfc6d587f0a20363bcb2e06b0b72faff29cc6ab0a52116017a8a29df7c82d77e8a21de50bdc706c9b6c9e1ad98aa40b1c0970d2278604f8d8fc67081d860a677ace7d8f2baa14d51887e2d5b85bdffc2e820c24a89674fa07bae629dae46810a477e3b1244cba88b59010d9a0e38af82e16d42ac112e86805b27da76a821252bf8b403e17ca6226eefcaf8722438cc3fd6cfbb4a653d9a4ab6bcd4e01aad60c2c4e0d8947f31c20b62db63b9bb7b0f1bc2cbe61803ee6b950227bfca1d1f1064d54096da8465abdde661c5d1982b35c090e5f8d9d4fe7e77644f25649082f35862e2de550b17109f65126ff76d7d70f7bace5708ea8c36c37302299b32b86fb95b4ba3859b2a85451c7defd8a1335b7f2ac4aee410ff0c56ec2da9a6f0eaacbdb0db10333f51c812dc29d26a8b7677ec0098432fffb3b6cbd8d23858c47b35d5d7ee9c936baa2881b6bbe86bfac584138e82fdc169736d2568bd84101ffe7d991e18a39052fb6d2bedf04ad295fa41d34eeee303f972b94c20941295c6d5684c78f04304f50a146f2856b3042c56dce82d1c126e03b623b87aae58e073073bdc540f6668f584220bd6ed49ce0e9c3145e75fe6e677405b55ed52487337f35115912daa1d6806d0544df97ecea65e9a968897aca0a473c0abe1986326596bfe6fa1422ec445908821dca46e32aba8038a248b0d8bc3f4a40bc9cc80299c4ae258a4d785d3f20831435f446d49004425b787e1214c14769f60625053809602881a7eac6bcd064b662e1f9ed937164387a721ad382ea0abdb8d184953653e9fd1d5560e7f9e8cb4b7e05091767e76a4be0d9ae268334da70a1a2ec0d49c6cfe8257222554dffacf884d56806368f99baf7006ba11870b10a34945bf3901886c1e5f94caf9097d1efb77ba64c40883ec380ac1167ab15a9acaf64d994d74c0a7a0066bd34717c6aa71eb1a515da37cc6ebaebf23811e8ad437927de44b7662946b9f112d19152de685341d20afdf89c37461e0ceeb81cdf493753c7d8ce0e3c327d48b2fddf3966ab414d57a33e4d6f9ac88ba574953bd85a21942da63274f92a78ca3e94165ac696b209be0e4fbe9918b7b568a4dce48b176e3faef3547f25c30188ca38f1ca332463f9a408606d05643383e9db516a3d5c50dab465a17d17120f2fa26b0460b42fe9288e6a8453ccc10eb5d7cc7fb00763533d502900df8ab7413e29139c85fefb1509cd9f9'

    addr = Web3.toChecksumAddress('0xAC570542F9837c3f413280cC75C2aDaE9CE09e2B')

    web3, pwd = connect()

    contract = web3.eth.contract(abi=abi, bytecode=bin, address=addr)

    num_questions = 106 # total number of questions in a task
    num_workers = 4     # total number of workers
    answers = []        # answers of a particular worker
    ansvec = []         # answers of all workers
    ciphertexts = []    # ciphertext of a particular worker
    ciphervec = []      # ciphertexts of all workers

    total_gas = 0

    golden_standard = []    # golden standard indices
    num_gold = 6
    golden_answers = []     # actual answers of golden standard


    print("-----Generate Same Workers Solutions-------------")
    # generating same solutions as workers with the same seed
    for j in range(0, num_workers):
        random.seed(j)
        for i in range(0, num_questions):
            ans = random.randint(0,1)
            answers.append(ans)
        ansvec.append(np.array(answers))
        print("Answers ", j , " : ", ansvec[j])
        answers = []


    print("-----Opening of Commitment to Gold Standard and solutions-------------")

    web3.personal.unlockAccount(web3.personal.listAccounts[2], pwd)
    opening_phase = contract.functions.opening_phase(golden_standard, golden_answers, randcom)
    if(opening_phase.call()):
        print("Opening Successfully Done! Commitments were correct!")
    else:
        print("Wrong Commitments!")
    gas = opening_phase.estimateGas()
    total_gas = total_gas + gas
    tx_hash = opening_phase.transact({'gas': gas, 'gasPrice': 5000000000})
    print(web3.toHex(tx_hash))
    tx_receipt = web3.eth.waitForTransactionReceipt(tx_hash, 600)
    print(tx_receipt)


    print("-----Encryption to get Ciphertexts-------------")

    for j in range(0, num_workers):
        ciphertexts = []
        for i in range(0, num_questions):
            random.seed(sha3(i*j))
            randi = random.getrandbits(256)
            rand.append(randi)
            ciphertexts.append(enc(int(ansvec[j][i]), randi))
        ciphervec.append(ciphertexts)

    print("Ciphertexts vec", ciphervec[1][12])
    c1, c2 = ciphervec[0][0]
    print(count_bitlen(c1), count_bitlen(c2))

    print("Golden indices: ", golden_standard)
    print("Golden answers: ", golden_answers)




    print("---------Proving Different Plaintexts for Wrong Solutions submitted by Workers")
    for j in range(0, num_workers):
        print("Solutions of Worker ", j)
        for i in range(0, num_gold):
            print(ansvec[j][golden_standard[i]])
            if(ansvec[j][golden_standard[i]] != golden_answers[i]):     #performing different plaintext proof if workers solution does not match with golden standard
                c_1, c_2 = ciphervec[j][golden_standard[i]]

                # Sigma protocol

                r = int.from_bytes(get_random_bytes(16), byteorder='big')
                A = c_1
                a = pow(A, r, p)
                a_bitlen = count_bitlen(a)

                c = int.from_bytes(sha3(int_to_bytes(a) + int_to_bytes(g) + int_to_bytes(h)), byteorder='big')
                c_bitlen = count_bitlen(c)

                print("c bitlen: %d" % c_bitlen)

                z = r + (c * k)
                z_bitlen = count_bitlen(z)

                web3.personal.unlockAccount(web3.personal.listAccounts[2], pwd)
                diff_plaintext_proof = contract.functions.different_plaintext_proof(int_to_bytes(c_1), count_bitlen(c_1), int_to_bytes(c_2), count_bitlen(c_2), golden_standard[i], web3.eth.accounts[3+j], int_to_bytes(a), a_bitlen, int_to_bytes(z), z_bitlen, c_bitlen)

                if(diff_plaintext_proof.call()):
                    print("Different Plaintext Proof Verified for Worker number ", j, " and question number ", golden_standard[i], "!")
                else:
                    print("Malicious Requester trying to fake Different Plaintext Proof for Worker number ",  j, " and question number ", golden_standard[i], "!")

                gas = diff_plaintext_proof.estimateGas()
                total_gas = total_gas + gas
                tx_hash = diff_plaintext_proof.transact({'gas': gas, 'gasPrice': 5000000000})
                print(web3.toHex(tx_hash))
                tx_receipt = web3.eth.waitForTransactionReceipt(tx_hash, 600)
                print(tx_receipt)
            else:
                print("Correct Solution found by Worker ", j, " for Question Num ", golden_standard[i])


    print("Total Gas: ", gas)

